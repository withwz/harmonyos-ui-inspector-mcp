# ç¬¬äºŒæœŸï¼šé¸¿è’™ UI è‡ªåŠ¨åŒ–æ§åˆ¶åŠŸèƒ½

## ç›®æ ‡

å°†ç°æœ‰çš„ MCP æœåŠ¡å™¨ä»"åªè¯»æŸ¥çœ‹"æ‰©å±•ä¸º"å¯æ§åˆ¶æ“ä½œ"ï¼Œè®© AI æ¨¡å‹èƒ½å¤Ÿï¼š
1. æŸ¥çœ‹å±å¹•çŠ¶æ€ï¼ˆå·²æœ‰ï¼‰
2. å®šä½ UI å…ƒç´ ï¼ˆå·²æœ‰ï¼Œéœ€ä¼˜åŒ–ï¼‰
3. æ‰§è¡Œæ§åˆ¶æ“ä½œï¼ˆæ–°å¢ï¼‰
4. å½¢æˆå®Œæ•´çš„è‡ªåŠ¨åŒ–é—­ç¯

---

## åŠŸèƒ½éœ€æ±‚

### 1. åŸºç¡€æ§åˆ¶æ“ä½œ

| åŠŸèƒ½ | å‘½ä»¤ | ä¼˜å…ˆçº§ |
|------|------|--------|
| ç‚¹å‡» | `hdc shell uinput -t -c \${x} \${y}` | P0 |
| æ»‘åŠ¨ | `hdc shell uinput -m \${x1} \${y1} \${x2} \${y2} \${duration}` | P0 |
| è¾“å…¥æ–‡å­— | `hdc shell uinput -t "\${text}"` | P0 |
| æŒ‰é”® | `hdc shell input keyevent \${code}` | P0 |
| å¯åŠ¨åº”ç”¨ | `hdc shell aa start -a A -b B` | P1 |
| åœæ­¢åº”ç”¨ | `hdc shell aa force-stop B` | P1 |

### 2. å…ƒç´ å®šä½å¢å¼º

| åŠŸèƒ½ | æè¿° | ä¼˜å…ˆçº§ |
|------|------|--------|
| æŒ‰æ–‡å­—æœç´¢ | åœ¨ nodeName ä¸­æœç´¢æ˜¾ç¤ºæ–‡å­— | P0 |
| æŒ‰åæ ‡è·å– | ä» UI æ ‘è·å–å…ƒç´ åæ ‡ | P0 |
| OCRè¯†åˆ« | é€šè¿‡æˆªå›¾+OCRè¯†åˆ«æ–‡å­—ä½ç½® | P1 |

### 3. æ™ºèƒ½æ“ä½œ

| åŠŸèƒ½ | æè¿° | ä¼˜å…ˆçº§ |
|------|------|--------|
| æ™ºèƒ½ç‚¹å‡» | æ ¹æ®æ–‡å­—/æ ‡ç­¾è‡ªåŠ¨ç‚¹å‡» | P1 |
| æ™ºèƒ½æ»šåŠ¨ | æ»šåŠ¨æŸ¥æ‰¾ç›®æ ‡å…ƒç´  | P2 |
| æ–­è¨€éªŒè¯ | æ“ä½œåéªŒè¯ç»“æœ | P2 |

---

## æŠ€æœ¯è®¾è®¡

### MCP å·¥å…·æ¥å£

```typescript
// 1. ç‚¹å‡»
{
  name: 'tap',
  description: 'ç‚¹å‡»å±å¹•æŒ‡å®šä½ç½®',
  inputSchema: {
    x: { type: 'number', description: 'Xåæ ‡' },
    y: { type: 'number', description: 'Yåæ ‡' }
  }
}

// 2. æ»‘åŠ¨
{
  name: 'swipe',
  description: 'æ»‘åŠ¨æ“ä½œ',
  inputSchema: {
    x1: { type: 'number' },
    y1: { type: 'number' },
    x2: { type: 'number' },
    y2: { type: 'number' },
    duration: { type: 'number', default: 300 }
  }
}

// 3. è¾“å…¥
{
  name: 'input_text',
  description: 'è¾“å…¥æ–‡å­—',
  inputSchema: {
    text: { type: 'string', description: 'è¦è¾“å…¥çš„æ–‡å­—' }
  }
}

// 4. æŒ‰é”®
{
  name: 'press_key',
  description: 'æŒ‰é”®æ“ä½œ',
  inputSchema: {
    key: {
      type: 'string',
      enum: ['BACK', 'HOME', 'VOLUME_UP', 'VOLUME_DOWN', 'POWER'],
      description: 'æŒ‰é”®åç§°'
    }
  }
}

// 5. åº”ç”¨æ§åˆ¶
{
  name: 'start_app',
  description: 'å¯åŠ¨åº”ç”¨',
  inputSchema: {
    bundleName: { type: 'string' },
    abilityName: { type: 'string', default: 'EntryAbility' }
  }
}

// 6. æ™ºèƒ½ç‚¹å‡»
{
  name: 'smart_tap',
  description: 'æ ¹æ®æ–‡å­—è‡ªåŠ¨ç‚¹å‡»',
  inputSchema: {
    text: { type: 'string', description: 'è¦ç‚¹å‡»çš„æ–‡å­—' },
    pid: { type: 'number', description: 'å¯é€‰ï¼šæŒ‡å®šè¿›ç¨‹' }
  }
}
```

### æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ index.ts                    # MCP æœåŠ¡å™¨å…¥å£ï¼ˆæ›´æ–°ï¼‰
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ hdc.ts                  # æ·»åŠ æ§åˆ¶æ–¹æ³•
â”œâ”€â”€ parsers/
â”‚   â”œâ”€â”€ renderService.ts        # æ·»åŠ æŒ‰æ–‡å­—æœç´¢
â”‚   â””â”€â”€ elementLocator.ts       # æ–°å¢ï¼šå…ƒç´ å®šä½å™¨
â””â”€â”€ automation/
    â”œâ”€â”€ controller.ts           # æ–°å¢ï¼šæ§åˆ¶é€»è¾‘
    â””â”€â”€ workflow.ts             # æ–°å¢ï¼šå·¥ä½œæµç¨‹
```

---

## å®æ–½æ­¥éª¤

### Phase 1: åŸºç¡€æ§åˆ¶ (P0)

- [ ] æ‰©å±• `HDC` ç±»æ·»åŠ æ§åˆ¶æ–¹æ³•
  - `tap(x, y)`
  - `swipe(x1, y1, x2, y2, duration)`
  - `inputText(text)`
  - `pressKey(code)`
- [ ] æ³¨å†Œæ–°çš„ MCP å·¥å…·
- [ ] æµ‹è¯•åŸºç¡€æ§åˆ¶åŠŸèƒ½

### Phase 2: å…ƒç´ å®šä½å¢å¼º (P0)

- [ ] ä¼˜åŒ– `get_ui_tree` çš„æ–‡å­—æœç´¢
- [ ] æ·»åŠ å…ƒç´ åæ ‡æå–åŠŸèƒ½
- [ ] å®ç° `smart_tap` æ™ºèƒ½ç‚¹å‡»

### Phase 3: åº”ç”¨æ§åˆ¶ (P1)

- [ ] æ·»åŠ  `start_app` / `stop_app`
- [ ] æ·»åŠ åº”ç”¨çŠ¶æ€æŸ¥è¯¢
- [ ] å®ç°åº”ç”¨é‡å¯æµç¨‹

### Phase 4: æ™ºèƒ½å·¥ä½œæµ (P2)

- [ ] å®ç°æ»šåŠ¨æŸ¥æ‰¾åŠŸèƒ½
- [ ] æ·»åŠ æ–­è¨€éªŒè¯
- [ ] æ„å»ºå®Œæ•´è‡ªåŠ¨åŒ–æµç¨‹

---

## æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•

```typescript
describe('HDC Controller', () => {
  it('should tap at coordinates', async () => {
    await hdc.tap(500, 1000);
  });

  it('should swipe from point A to B', async () => {
    await hdc.swipe(500, 1000, 500, 500, 300);
  });
});
```

### é›†æˆæµ‹è¯•

```typescript
describe('UI Automation', () => {
  it('should launch app and tap button', async () => {
    await hdc.startApp('com.example.app');
    await new Promise(r => setTimeout(r, 2000));
    await hdc.smartTap('ç™»å½•');
  });
});
```

---

## é£é™©ä¸é™åˆ¶

### é£é™©

1. **æ–‡å­—å†…å®¹è·å–**ï¼šhidumper è¾“å‡ºå¯èƒ½ä¸åŒ…å«æ‰€æœ‰æ–‡å­—
   - ç¼“è§£ï¼šä½¿ç”¨ OCR ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ

2. **åæ ‡ç²¾åº¦**ï¼šä¸åŒè®¾å¤‡åˆ†è¾¨ç‡ä¸åŒ
   - ç¼“è§£ï¼šæ”¯æŒç›¸å¯¹åæ ‡ï¼ˆç™¾åˆ†æ¯”ï¼‰

3. **å¼‚æ­¥æ“ä½œ**ï¼šåº”ç”¨å¯åŠ¨ã€ç•Œé¢è·³è½¬éœ€è¦ç­‰å¾…
   - ç¼“è§£ï¼šæ·»åŠ ç­‰å¾…æœºåˆ¶

### é™åˆ¶

1. ä¸æ”¯æŒè·¨åº”ç”¨æ“ä½œï¼ˆæ¯æ¬¡åªèƒ½æ“ä½œä¸€ä¸ªåº”ç”¨ï¼‰
2. éœ€è¦è®¾å¤‡å·²é€šè¿‡ hdc è¿æ¥
3. æŸäº›ç³»ç»Ÿæ“ä½œå¯èƒ½éœ€è¦ root æƒé™

---

## å‚è€ƒèµ„æº

- [é¸¿è’™ hdc å‘½ä»¤æ–‡æ¡£](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/ide-hdc-command-V5)
- [hmdriver2 è‡ªåŠ¨åŒ–æ¡†æ¶](https://testerhome.com/topics/40667)
- [Appium é¸¿è’™é©±åŠ¨](https://zhuanlan.zhihu.com/p/1952431444107419975)

---

## æ—¶é—´ä¼°ç®—

- Phase 1: 2-3å°æ—¶
- Phase 2: 2-3å°æ—¶
- Phase 3: 1-2å°æ—¶
- Phase 4: 3-4å°æ—¶

**æ€»è®¡**: çº¦ 8-12 å°æ—¶

---

## Code Review å‘ç°çš„é—®é¢˜ (2024-01-28)

é€šè¿‡ subagent code-reviewer è¿›è¡Œç‹¬ç«‹ä»£ç å®¡æŸ¥ï¼Œå‘ç°ä»¥ä¸‹éœ€è¦ä¿®å¤çš„é—®é¢˜ï¼š

### ğŸ”´ ä¸¥é‡é—®é¢˜ (P0)

#### 1. HDC å‘½ä»¤è¯­æ³•é”™è¯¯
**ä½ç½®**: plan.md ç¬¬ 19-22 è¡Œï¼Œcontroller.ts ä¸ hdc.ts å‘½ä»¤ä¸ä¸€è‡´

```typescript
// plan.md ä¸­é”™è¯¯çš„å‘½ä»¤
hdc shell uinput -t -c x y        // âŒ é”™è¯¯è¯­æ³•
hdc shell uinput -m x1 y1 x2 y2   // âŒ é”™è¯¯è¯­æ³•

// hdc.ts ä¸­çš„å®ç° (æ­£ç¡®)
hdc shell uinput -t -c ${x} ${y}  // âœ…
hdc shell uinput -m ${x1} ${y1} ${x2} ${y2} ${duration}  // âœ…

// controller.ts ä¸­ä½¿ç”¨äº†ä¸åŒçš„å‘½ä»¤
hdc shell uiauto tap ${x} ${y}    // âš ï¸ ä¸ hdc.ts ä¸ä¸€è‡´
```

**å½±å“**: å‘½ä»¤å¯èƒ½æ— æ³•æ­£å¸¸æ‰§è¡Œ

**ä¿®å¤æ–¹æ¡ˆ**: ç»Ÿä¸€ä½¿ç”¨ `uinput` å‘½ä»¤é›†ï¼Œæ›´æ–° plan.md æ–‡æ¡£

#### 2. åæ ‡æå–å®Œå…¨æ— æ•ˆ
**ä½ç½®**: controller.ts ç¬¬ 211-239 è¡Œï¼ŒelementLocator.ts

```typescript
// å°è¯•ä» modifiers è·å– bounds
if (modifiers && modifiers.bounds) {
  // modifiers.bounds åªæ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ trueï¼Œä¸åŒ…å«åæ ‡ä¿¡æ¯ï¼
  // è¿™æ®µä»£ç æ°¸è¿œä¸ä¼šæˆåŠŸæå–åæ ‡
}
```

**æ ¹æœ¬åŸå› **: `renderService.ts` çš„ `parseModifiers` æ–¹æ³•åªè®¾ç½®äº† `bounds: true` æ ‡å¿—ï¼Œæ²¡æœ‰è§£æå®é™…åæ ‡å€¼ã€‚

**å½±å“**: `smart_tap` åŠŸèƒ½æ— æ³•å·¥ä½œï¼Œå› ä¸ºæ— æ³•è·å–å…ƒç´ åæ ‡

**ä¿®å¤æ–¹æ¡ˆ**:
- æ–¹æ¡ˆ A: ä¿®æ”¹ `parseModifiers` è§£æå®é™…çš„ bounds åæ ‡
- æ–¹æ¡ˆ B: ä½¿ç”¨ OCR ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
- æ–¹æ¡ˆ C: éœ€è¦è¿›ä¸€æ­¥ç ”ç©¶ hidumper æ˜¯å¦è¾“å‡ºåæ ‡ä¿¡æ¯

### ğŸŸ  é‡è¦é—®é¢˜ (P1)

#### 3. ç¼ºå°‘è¾“å…¥éªŒè¯
**ä½ç½®**: controller.ts, hdc.ts

```typescript
// tap æ–¹æ³•æ²¡æœ‰éªŒè¯åæ ‡èŒƒå›´
async tap(x: number, y: number): Promise<string> {
  // æ²¡æœ‰æ£€æŸ¥ x, y æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…
  return await this.shell(`uinput -t -c ${x} ${y}`);
}
```

**å½±å“**: å¯èƒ½å¯¼è‡´è®¾å¤‡å¼‚å¸¸æˆ–å‘½ä»¤å¤±è´¥

**ä¿®å¤æ–¹æ¡ˆ**: æ·»åŠ åæ ‡èŒƒå›´æ£€æŸ¥ï¼ˆ0 <= x <= screenWidth, 0 <= y <= screenHeightï¼‰

#### 4. å‘½ä»¤é›†ä¸ä¸€è‡´
- hdc.ts ä½¿ç”¨ `uinput` ç³»åˆ—
- controller.ts ä½¿ç”¨ `uiauto` ç³»åˆ—

**ä¿®å¤æ–¹æ¡ˆ**: ç»Ÿä¸€ä½¿ç”¨ä¸€å¥—å‘½ä»¤ï¼Œå¹¶åœ¨æ–‡æ¡£ä¸­è¯´æ˜

### ğŸŸ¡ æ¬¡è¦é—®é¢˜ (P2)

#### 5. renderService.ts ä¸­ç±»å‹å®šä¹‰é”™è¯¯
**ä½ç½®**: plan.md ç¬¬ 77 è¡Œ

```typescript
text: { type: 'number', description: 'è¦è¾“å…¥çš„æ–‡å­—' }  // âŒ åº”è¯¥æ˜¯ string
```

#### 6. é”™è¯¯å¤„ç†ä¸å®Œå–„
- ç¼ºå°‘è®¾å¤‡æœªè¿æ¥çš„é”™è¯¯å¤„ç†
- ç¼ºå°‘å‘½ä»¤æ‰§è¡Œè¶…æ—¶å¤„ç†
- ç¼ºå°‘é‡è¯•æœºåˆ¶

#### 7. æœªä½¿ç”¨çš„å˜é‡å’Œä»£ç 
- controller.ts ç¬¬ 114 è¡Œ: `const command = ...` å£°æ˜ä½†æœªä½¿ç”¨

### å»ºè®®ä¿®å¤ä¼˜å…ˆçº§

1. **ç«‹å³ä¿®å¤**: ä¿®å¤ plan.md ä¸­çš„å‘½ä»¤è¯­æ³•é”™è¯¯
2. **P0**: ç ”ç©¶åæ ‡æå–æ–¹æ¡ˆï¼ˆéœ€è¦å®é™…è®¾å¤‡æµ‹è¯•ï¼‰
3. **P1**: æ·»åŠ è¾“å…¥éªŒè¯ï¼Œç»Ÿä¸€å‘½ä»¤é›†
4. **P2**: å®Œå–„é”™è¯¯å¤„ç†ï¼Œæ¸…ç†æœªä½¿ç”¨ä»£ç 

### éœ€è¦è¿›ä¸€æ­¥ç ”ç©¶çš„é—®é¢˜

1. **åæ ‡æ¥æº**: é¸¿è’™ç³»ç»Ÿçš„ hidumper æ˜¯å¦çœŸçš„è¾“å‡ºå…ƒç´ åæ ‡ï¼Ÿ
   - å¦‚æœä¸è¾“å‡ºï¼Œéœ€è¦è€ƒè™‘ OCR æ–¹æ¡ˆ
   - æˆ–è€…ä½¿ç”¨ `uiauto` å‘½ä»¤çš„å…¶ä»–å­å‘½ä»¤

2. **å‘½ä»¤å…¼å®¹æ€§**: `uinput` å’Œ `uiauto` å‘½ä»¤é›†çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ
   - éœ€è¦åœ¨çœŸå®è®¾å¤‡ä¸Šæµ‹è¯•
   - å¯èƒ½éœ€è¦æ ¹æ®ç³»ç»Ÿç‰ˆæœ¬é€‰æ‹©å‘½ä»¤é›†

3. **æ–‡å­—å†…å®¹æå–**: hidumper è¾“å‡ºä¸­ nodeName çš„æ ¼å¼
   - å½“å‰æ ¼å¼: `AppName_text_åŒ…å_æ˜¾ç¤ºæ–‡å­—_id`
   - éœ€è¦æ›´å¯é çš„è§£æé€»è¾‘
