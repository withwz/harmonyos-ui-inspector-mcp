# 实现计划

## 项目结构

```
harmonyos-rn-ui-inspector-mcp/
├── server/
│   ├── src/
│   │   ├── index.ts              # MCP 服务器入口
│   │   ├── tools/
│   │   │   ├── listWindows.ts    # 列出窗口
│   │   │   ├── getUiTree.ts      # 获取 UI 树
│   │   │   └── screenshot.ts     # 截图
│   │   ├── parsers/
│   │   │   ├── windowManager.ts  # 解析 WindowManagerService 输出
│   │   │   ├── renderService.ts  # 解析 RenderService 输出
│   │   │   └── abilityManager.ts # 解析 AbilityManagerService 输出
│   │   └── utils/
│   │       └── hdc.ts            # hdc 命令执行
│   ├── package.json
│   ├── tsconfig.json
│   └── build.sh                  # 编译脚本
└── docs/
    └── (本目录下的 md 文件)
```

## 实现阶段

### Phase 1: 基础框架

**目标**: 搭建 MCP 服务器基本框架

**任务**:
1. 创建项目目录结构
2. 初始化 `package.json`
3. 配置 TypeScript
4. 实现基本的 MCP Server (echo/hello world)
5. 测试连接

**验证**:
- 运行 `/mcp` 能看到服务器
- 能调用一个测试工具

---

### Phase 2: 窗口列表功能

**目标**: 实现 `list_windows` 工具

**任务**:
1. 实现 `utils/hdc.ts` - hdc 命令执行
2. 实现 `parsers/windowManager.ts` - 解析窗口列表输出
3. 实现 `tools/listWindows.ts` - 工具逻辑
4. 注册到 MCP Server

**数据结构**:
```typescript
interface WindowInfo {
  name: string;        // WindowName
  pid: number;         // 进程 ID
  winId: number;       // 窗口 ID
  type: number;        // 窗口类型
  zOrder: number;      // Z 轴顺序
  rect: {
    x: number;
    y: number;
    w: number;
    h: number;
  };
}
```

**验证**:
- 调用工具返回窗口列表
- RN 应用窗口 (rnsurface0) 能正确识别

---

### Phase 3: UI 树功能 ⭐ 核心功能

**目标**: 实现 `get_ui_tree` 工具

**任务**:
1. 实现 `parsers/renderService.ts` - 解析 RenderService client 输出
2. 实现树状结构解析（处理 `|` 层级符号）
3. 实现 `tools/getUiTree.ts` - 工具逻辑
4. 支持按 pid 过滤

**数据结构**:
```typescript
interface UINode {
  id: string;          // 节点 ID
  type: string;        // SurfaceNode, RootNode, CanvasNode 等
  name?: string;       // 节点名称
  frameNodeId?: string;
  frameNodeTag?: string;
  parent?: string;     // 父节点 ID
  children: UINode[];  // 子节点
  modifiers?: Record<string, any>;  // 属性
}
```

**验证**:
- 返回完整的 UI 树
- 能看到 RN 应用的组件

---

### Phase 4: 截图功能

**目标**: 实现 `screenshot` 工具

**任务**:
1. 实现 `tools/screenshot.ts`
2. 截图保存到临时目录
3. 返回图片路径或 base64

**验证**:
- 成功获取截图
- 图片可读

---

### Phase 5: 插件集成

**目标**: 集成到 Claude Code

**任务**:
1. 创建 `~/.claude/plugins/harmonyos-rn-ui/` 目录
2. 创建 `plugin.json`
3. 创建 `.mcp.json`
4. 复制编译后的服务器文件
5. 测试

**验证**:
- Claude Code 重启后自动加载
- `/mcp` 能看到工具
- 工具调用正常

---

## 关键文件清单

### 需要创建的文件

| 文件 | 用途 |
|------|------|
| `server/src/index.ts` | MCP 服务器入口 |
| `server/src/utils/hdc.ts` | hdc 命令封装 |
| `server/src/parsers/windowManager.ts` | 窗口列表解析 |
| `server/src/parsers/renderService.ts` | UI 树解析 |
| `server/src/tools/listWindows.ts` | list_windows 工具 |
| `server/src/tools/getUiTree.ts` | get_ui_tree 工具 |
| `server/package.json` | 项目配置 |
| `server/tsconfig.json` | TypeScript 配置 |
| `~/.claude/plugins/harmonyos-rn-ui/plugin.json` | 插件配置 |
| `~/.claude/plugins/harmonyos-rn-ui/.mcp.json` | MCP 配置 |

---

## 命令速查

### hidumper 命令

```bash
# 窗口列表
hdc shell "hidumper -s WindowManagerService -a '-a'"

# UI 组件树 (所有应用)
hdc shell "hidumper -s RenderService -a 'client'"

# 应用列表
hdc shell "hidumper -s AbilityManagerService -a '-a'"

# 截图
hdc shell "snapshot_display -f /data/local/tmp/screenshot.jpeg"
hdc file recv /data/local/tmp/screenshot.jpeg /tmp/screenshot.jpeg
```

### 开发命令

```bash
# 编译
cd server && npm run build

# 测试 MCP 服务器
node dist/index.js

# 在 Claude 中查看 MCP 状态
/mcp
```

---

## 估计复杂度

| 阶段 | 复杂度 | 主要挑战 |
|------|--------|----------|
| Phase 1 | ⭐ | 环境配置 |
| Phase 2 | ⭐⭐ | 解析格式化输出 |
| Phase 3 | ⭐⭐⭐⭐ | 树状结构解析，大输出处理 |
| Phase 4 | ⭐⭐ | 文件传输 |
| Phase 5 | ⭐⭐ | 插件集成调试 |

---

## 下一步行动

准备好后，从 Phase 1 开始实现！
