# MCP UI Inspector 痛点分析与改进计划

> 基于 Claude Code 使用 harmonyos-ui-inspector-mcp 的实际经验整理

---

## 一、使用痛点

### 1.1 文字输入功能缺失

**问题描述**：
- `press_key` 返回的 Usage 显示有 `text <text>` 命令可以直接输入文字
- 但 MCP 工具列表中**没有暴露** `text` 功能
- 导致无法自动化输入搜索关键词等文字操作

**影响**：
- 搜索功能测试需要手动输入
- 表单填写无法自动化
- 调试效率大幅降低

**建议改进**：
```typescript
// 添加 text 工具到 MCP server
{
  name: 'text',
  description: '在焦点处输入文字',
  inputSchema: {
    type: 'object',
    properties: {
      text: { type: 'string', description: '要输入的文字' }
    },
    required: ['text']
  }
}
```

---

### 1.2 smart_tap 功能不稳定

**问题描述**：
- 多次尝试 `smart_tap "搜索 Demo"` 无法找到元素
- 最终只能用坐标 `tap(x, y)` 点击
- 文字匹配算法可能有问题

**影响**：
- 智能点击不可靠
- 需要手动计算坐标
- 不同屏幕分辨率坐标不同，无法通用

**建议改进**：
1. 增强文字匹配算法：
   - 支持模糊匹配
   - 支持 OCR 文字识别
   - 支持正则表达式

2. 添加调试模式：
```typescript
smart_tap(text: string, debug: boolean = false) {
  // 返回所有匹配的元素信息
  if (debug) {
    return allMatches
  }
}
```

---

### 1.3 UI 状态难以实时监控

**问题描述**：
- 只能通过 `screenshot` 获取静态画面
- 无法实时获取组件状态（如展开/收起、聚焦等）
- `get_ui_tree` 返回的是结构，不是交互状态

**影响**：
- 调试状态问题困难
- 需要反复截图确认
- 无法断点调试 UI 状态

**建议改进**：
添加 `get_component_state` 工具：
```typescript
{
  name: 'get_component_state',
  description: '获取指定组件的交互状态',
  inputSchema: {
    type: 'object',
    properties: {
      frameNodeId: { type: 'string' },
      properties: { type: 'array', items: { type: 'string' } }
    }
  }
}
// 返回: { expanded: boolean, focused: boolean, visible: boolean, ... }
```

---

### 1.4 元素定位能力有限

**问题描述**：
- `get_ui_tree` 返回 frameNodeId 和 frameNodeTag
- 没有直接的"可点击元素"筛选
- 需要自己分析哪些元素可交互

**影响**：
- 自动化脚本编写复杂
- 需要了解内部结构
- 容易定位到不可交互元素

**建议改进**：
1. 添加 `get_interactive_elements` 工具：
```typescript
// 只返回可交互的元素（按钮、输入框等）
{
  clickable: boolean,
  focusable: boolean,
  enabled: boolean
}
```

2. 优化 `get_ui_tree` 输出：
   - 标记每个元素的交互类型
   - 添加 bounds（位置和大小）
   - 添加 accessibility 信息

---

### 1.5 错误反馈不清晰

**问题描述**：
- 部分工具执行失败时错误信息模糊
- `smart_tap` 未找到元素时没有返回候选列表
- 难以定位问题原因

**影响**：
- 调试困难
- 不知道是参数问题还是设备问题

**建议改进**：
统一错误格式：
```typescript
{
  success: false,
  error: {
    code: 'ELEMENT_NOT_FOUND',
    message: '未找到包含指定文字的元素',
    candidates: [  // 返回所有相似元素
      { text: '搜索', similarity: 0.8, ... }
    ]
  }
}
```

---

## 二、功能改进建议

### 2.1 工作流编排能力

**需求**：
支持复杂的 UI 自动化场景，如：
- "打开应用 → 点击搜索 → 输入文字 → 点击第一个结果"
- "滚动列表直到出现指定元素"

**建议实现**：
添加 `execute_workflow` 工具：
```typescript
{
  name: 'execute_workflow',
  description: '执行预定义的工作流',
  inputSchema: {
    type: 'object',
    properties: {
      steps: {
        type: 'array',
        items: {
          type: 'object',
          properties: {
            action: { type: 'string', enum: ['tap', 'input', 'swipe', 'wait'] },
            target: { type: 'string' },
            value: { type: 'string' },
            timeout: { type: 'number' }
          }
        }
      }
    }
  }
}
```

---

### 2.2 断言与验证能力

**需求**：
自动化测试需要验证 UI 状态，如：
- 验证元素是否存在
- 验证文本内容
- 验证组件状态（展开/收起）

**建议实现**：
```typescript
{
  name: 'assert_element',
  description: '断言元素状态',
  inputSchema: {
    type: 'object',
    properties: {
      frameNodeId: { type: 'string' },
      condition: {
        type: 'object',
        properties: {
          visible: { type: 'boolean' },
          containsText: { type: 'string' },
          expanded: { type: 'boolean' }
        }
      }
    }
  }
}
```

---

### 2.3 OCR 能力增强

**需求**：
- 当前只能通过 frameNodeTag 粗略判断类型
- 无法获取元素实际显示的文字
- 智能点击依赖 hdc 的 accessibility 信息

**建议实现**：
```typescript
{
  name: 'ocr_element',
  description: 'OCR 识别指定区域的文字',
  inputSchema: {
    type: 'object',
    properties: {
      region: { type: 'object', properties: { x, y, width, height } }
    }
  }
}
// 返回识别到的文字列表及其位置
```

---

### 2.4 元素高亮与调试模式

**需求**：
调试时需要知道元素的具体位置和边界。

**建议实现**：
```typescript
{
  name: 'highlight_element',
  description: '高亮显示指定元素',
  inputSchema: {
    type: 'object',
    properties: {
      frameNodeId: { type: 'string' },
      duration: { type: 'number', default: 2000 }
    }
  }
}
// 在设备上绘制边框高亮显示元素，方便截图
```

---

### 2.5 日志与录制能力

**需求**：
- 保存操作历史用于回放
- 记录性能数据

**建议实现**：
```typescript
{
  name: 'start_recording',
  description: '开始录制操作'
}

{
  name: 'stop_recording',
  description: '停止录制并保存',
  inputSchema: {
    type: 'object',
    properties: {
      format: { type: 'string', enum: ['json', 'yaml', 'code'] }
    }
  }
}
// 返回可执行代码或测试报告
```

---

## 三、技术优化建议

### 3.1 性能优化

**当前问题**：
- `get_ui_tree` 返回完整 JSON 数据量大
- 解析 UI 树耗时较长

**建议**：
1. 添加懒加载模式：只解析可见区域
2. 添加缓存机制：短时间内多次查询使用缓存
3. 支持增量更新：只返回变化的部分

---

### 3.2 稳定性优化

**当前问题**：
- hdc 命令偶尔失败无响应
- 网络波动导致连接中断

**建议**：
1. 添加重试机制：自动重试失败的命令
2. 添加心跳检测：定期检查设备连接状态
3. 添加超时控制：避免长时间等待

---

### 3.3 兼容性扩展

**当前限制**：
- 只支持特定的 HarmonyOS 版本
- 部分命令在不同设备表现不同

**建议**：
1. 添加设备信息查询：`get_device_info`
2. 添加版本适配层：根据系统版本选择命令
3. 添加fallback机制：不支持的高级功能自动降级

---

## 四、优先级排序

### P0 - 必须修复（影响核心使用）

1. ✅ **添加 text 输入工具** - 最高优先级
2. ✅ **修复 smart_tap 匹配算法** - 提高可靠性
3. ✅ **优化错误反馈信息** - 便于调试

### P1 - 重要增强（大幅提升效率）

4. **添加工作流编排能力** - 支持复杂场景
5. **添加断言验证工具** - 支持自动化测试
6. **添加元素高亮工具** - 辅助调试

### P2 - 有用功能（锦上添花）

7. **实现 OCR 能力** - 增强文字识别
8. **添加日志录制功能** - 支持操作回放
9. **性能优化** - 提升响应速度

---

## 五、协作建议

为方便后续开发，建议：

1. **创建 GitHub Issues**：每个痛点创建一个 Issue
2. **维护 Feature Request 文档**：记录所有建议的功能
3. **定期同步 Claude**：将更新后的能力同步给 AI 了解
4. **添加使用示例**：每个工具添加使用示例代码

---

> 创建时间: 2025-02-14
> 基于实际使用经验整理，优先级可能因场景而异
